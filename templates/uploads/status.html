{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="uploadProgress({{ batch.id }})" x-init="init()">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Upload Status: {{ batch.file_name }}</h2>
    
    <div class="bg-white p-6 rounded-lg shadow">
        <!-- Real-time Status Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-800" x-text="total">{{ batch.total_records }}</div>
                <div class="text-sm text-gray-600">Total Records</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-800" x-text="processed">{{ batch.processed_records }}</div>
                <div class="text-sm text-gray-600">Processed</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-800" x-text="successful">{{ batch.successful_records }}</div>
                <div class="text-sm text-green-600">Successful</div>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg">
                <div class="text-2xl font-bold text-red-800" x-text="failed">{{ batch.failed_records }}</div>
                <div class="text-sm text-red-600">Failed</div>
            </div>
        </div>

        <!-- Real-time Progress Bar -->
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span>Progress</span>
                <span x-text="progress + '%'">{{ progress }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="bg-blue-600 h-4 rounded-full transition-all duration-500" 
                     :style="'width: ' + progress + '%'"
                     style="width: {{ progress }}%">
                </div>
            </div>
        </div>

        <!-- Real-time Status -->
        <div class="mb-6">
            <span class="px-3 py-1 text-sm font-semibold rounded-full 
                {% if batch.status == 'completed' %}bg-green-100 text-green-800
                {% elif batch.status == 'processing' %}bg-yellow-100 text-yellow-800
                {% elif batch.status == 'failed' %}bg-red-100 text-red-800
                {% else %}bg-gray-100 text-gray-800{% endif %}"
                x-text="statusText">
                {{ batch.status|title }}
            </span>
            
            <!-- Auto-refresh message -->
            <div x-show="status === 'processing'" class="mt-2 text-sm text-blue-600">
                âš¡ Live updating... 
                <span x-text="lastUpdate">just now</span>
            </div>
        </div>

        <!-- Real-time Processing Speed -->
        <div x-show="status === 'processing'" class="mb-6 p-4 bg-blue-50 rounded-lg">
            <div class="text-sm text-blue-800">
                <strong>Processing speed:</strong> 
                <span x-text="processingSpeed">Calculating...</span> records per second
                <span x-show="eta" class="ml-4">
                    <strong>ETA:</strong> <span x-text="eta"></span>
                </span>
            </div>
        </div>

        <!-- Webhook Status -->
        <div x-show="status === 'processing' || status === 'completed'" class="mb-6 p-4 bg-purple-50 rounded-lg">
            <div class="text-sm text-purple-800">
                <strong>Webhooks:</strong> 
                <span x-text="webhookStatus">Active</span>
            </div>
        </div>

        <!-- Errors (auto-updates) -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">
                Errors (<span x-text="failed">{{ batch.failed_records }}</span>):
            </h3>
            <div class="bg-red-50 border border-red-200 rounded-md p-4 max-h-60 overflow-y-auto">
                {% if batch.errors %}
                    {% for error in batch.errors %}
                    <div class="text-sm text-red-700 mb-2 pb-2 {% if not forloop.last %}border-b border-red-100{% endif %}">
                        <strong>Row {{ error.row }}</strong> 
                        (SKU: {{ error.sku }}): 
                        {{ error.error }}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-sm text-gray-500">No errors</div>
                {% endif %}
                
                <!-- Dynamic errors will appear here -->
                <template x-for="error in errors" :key="error.row">
                    <div class="text-sm text-red-700 mb-2 pb-2 border-b border-red-100 last:border-b-0">
                        <strong>Row <span x-text="error.row"></span></strong> 
                        (SKU: <span x-text="error.sku"></span>): 
                        <span x-text="error.error"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Completion Message -->
        {% if batch.status == 'completed' %}
        <div class="mt-6 p-4 bg-green-50 rounded-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-green-800 font-medium">Processing completed successfully!</span>
            </div>
            <div class="mt-2 text-sm text-green-700">
                <strong>Summary:</strong> 
                {{ batch.successful_records }} products processed, 
                {{ batch.failed_records }} errors
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="mt-6 flex space-x-3">
            <a href="{% url 'upload-history' %}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                Back to History
            </a>
            <a href="{% url 'upload-csv' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                New Upload
            </a>
            <a href="{% url 'product-list' %}" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                View Products
            </a>
            <a href="{% url 'webhook-list' %}" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                Webhooks
            </a>
        </div>
    </div>
</div>

<script>
function uploadProgress(batchId) {
    return {
        batchId: batchId,
        status: '{{ batch.status }}',
        processed: {{ batch.processed_records }},
        total: {{ batch.total_records }},
        successful: {{ batch.successful_records }},
        failed: {{ batch.failed_records }},
        progress: {{ progress }},
        
        // UI states
        processingSpeed: 'Starting...',
        eta: 'Calculating...',
        lastUpdate: 'just now',
        connectionStatus: 'polling',
        webhookStatus: 'Using reliable updates',
        startTime: new Date(),
        pollInterval: null,
        
        init() {
            console.log('ðŸš€ Starting reliable polling for batch:', this.batchId);
            this.startPolling();
        },
        
        startPolling() {
            // Poll every 2 seconds
            this.pollInterval = setInterval(() => {
                this.fetchProgress();
            }, 2000);
            
            // Immediate first fetch
            this.fetchProgress();
        },
        
        fetchProgress() {
            fetch(/upload/status/${this.batchId}/, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json())
            .then(data => this.updateData(data))
            .catch(err => console.error('Poll error:', err));
        },
        
        updateData(data) {
            this.status = data.status;
            this.processed = data.processed;
            this.total = data.total;
            this.successful = data.successful;
            this.failed = data.failed;
            this.progress = data.progress;
            this.lastUpdate = new Date().toLocaleTimeString();
            
            // Calculate metrics
            if (this.status === 'processing' && this.processed > 0) {
                const elapsed = (new Date() - this.startTime) / 1000;
                const speed = Math.round(this.processed / elapsed);
                this.processingSpeed = ${speed} records/sec;
                
                if (speed > 0) {
                    const remaining = this.total - this.processed;
                    this.eta = this.formatTime(remaining / speed);
                }
            }
            
            // Stop when done
            if (this.status === 'completed' || this.status === 'failed') {
                clearInterval(this.pollInterval);
            }
        },
        
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins > 0 ? ${mins}m ${secs}s : ${secs}s;
        }
    };
}
</script>

<style>
.transition-all {
    transition: all 0.5s ease;
}
</style>
{% endblock %}
